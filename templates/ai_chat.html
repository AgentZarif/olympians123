{% extends "base.html" %}

{% block title %}AI Chat - Olympus{% endblock %}

{% block content %}
<section class="ai-chat-section">
    <div class="ai-chat-container">
        <div class="chat-panel">
            <div class="chat-panel-header">
                <h1>ü§ñ AI ‡¶ü‡¶ø‡¶â‡¶ü‡¶∞ (Gemini)</h1>
                <p>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º ‡¶Ö‡¶≤‡¶ø‡¶Æ‡ßç‡¶™‡¶ø‡¶Ø‡¶º‡¶æ‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>

            <div class="ai-messages" id="aiMessages">
                <div class="ai-message bot">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-bubble">
                        <p>Hello! ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø:</p>
                        <ul>
                            <li>‡¶ó‡¶£‡¶ø‡¶§ ‡¶Ö‡¶≤‡¶ø‡¶Æ‡ßç‡¶™‡¶ø‡¶Ø‡¶º‡¶æ‡¶° ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ï‡¶∞‡¶§‡ßá</li>
                            <li>‡¶ß‡¶æ‡¶™‡ßá ‡¶ß‡¶æ‡¶™‡ßá ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá</li>
                            <li>‡¶™‡¶°‡¶º‡¶æ‡¶∂‡ßã‡¶®‡¶æ‡¶∞ ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶ì ‡¶ï‡ßå‡¶∂‡¶≤</li>
                            <li>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶®‡¶ø‡¶§‡ßá</li>
                        </ul>
                        <p>‡¶Ü‡¶ú ‡¶ï‡ßÄ ‡¶∂‡¶ø‡¶ñ‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?</p>
                    </div>
                </div>
            </div>

            <div class="ai-input-area">
                <button class="ai-clear-btn" id="aiClearBtn" title="‡¶ï‡¶•‡¶™‡ßã‡¶ï‡¶•‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®">
                    <span>üóëÔ∏è</span>
                </button>
                <input type="text" class="ai-input" id="aiInput" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßá‡¶ñ‡ßã..."
                    autocomplete="off">
                <button class="ai-send-btn" id="aiSendBtn">
                    <span>Send</span>
                </button>
            </div>
        </div>
    </div>
</section>

<style>
    .ai-clear-btn {
        background: #ef4444;
        color: white;
        border: none;
        width: 50px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }

    .ai-clear-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
    }

    .message-bubble ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .message-bubble li {
        margin-bottom: 0.25rem;
    }

    .message-bubble strong {
        color: #2563eb;
    }
</style>

<script>
    const aiMessages = document.getElementById('aiMessages');
    const aiInput = document.getElementById('aiInput');
    const aiSendBtn = document.getElementById('aiSendBtn');
    const aiClearBtn = document.getElementById('aiClearBtn');

    // Conversation history to send as context
    let conversationHistory = [];

    // Simple Markdown Parser
    function parseMarkdown(text) {
        // Bold
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // List items (hyphen at start of line)
        text = text.replace(/^- (.*)/gm, '<li>$1</li>');
        // Wrap lists (consecutive li's) - simplified approach
        // We will just replace newlines with BR, providing basic structure
        text = text.replace(/\n/g, '<br>');
        return text;
    }

    // Clear Chat
    aiClearBtn.addEventListener('click', () => {
        if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶¨ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ï‡¶•‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
            conversationHistory = [];
            // Keep only the welcome message
            const welcomeMsg = aiMessages.children[0].outerHTML;
            aiMessages.innerHTML = welcomeMsg;
        }
    });

    async function sendAIMessage() {
        const message = aiInput.value.trim();
        if (!message) return;

        // Add user message to UI
        const userMsg = document.createElement('div');
        userMsg.className = 'ai-message user';
        userMsg.innerHTML = `
            <div class="message-bubble">
                <p>${message}</p>
            </div>
            <div class="message-avatar">üë§</div>
        `;
        aiMessages.appendChild(userMsg);
        aiInput.value = '';
        aiMessages.scrollTop = aiMessages.scrollHeight;

        // Add to history
        conversationHistory.push({ role: 'student', content: message });

        // Add typing indicator
        const typingMsg = document.createElement('div');
        typingMsg.className = 'ai-message bot typing';
        typingMsg.innerHTML = `
            <div class="message-avatar">ü§ñ</div>
            <div class="message-bubble">
                <p>‚è≥ AI ‡¶ü‡¶ø‡¶â‡¶ü‡¶∞ ‡¶ö‡¶ø‡¶®‡ßç‡¶§‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá...</p>
            </div>
        `;
        aiMessages.appendChild(typingMsg);
        aiMessages.scrollTop = aiMessages.scrollHeight;

        try {
            // Call Gemini AI backend
            const response = await fetch('/api/ai/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message,
                    context: conversationHistory
                })
            });

            const data = await response.json();

            // Remove typing indicator
            typingMsg.remove();

            // Add AI response to UI
            const botMsg = document.createElement('div');
            botMsg.className = 'ai-message bot';

            if (response.ok && data.response) {
                // Add to history
                conversationHistory.push({ role: 'tutor', content: data.response });

                botMsg.innerHTML = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-bubble">
                        <p>${parseMarkdown(data.response)}</p>
                    </div>
                `;
            } else {
                botMsg.innerHTML = `
                    <div class="message-avatar">‚ö†Ô∏è</div>
                    <div class="message-bubble error">
                        <p><strong>‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:</strong> ${data.error || 'AI ‡¶ü‡¶ø‡¶â‡¶ü‡¶∞ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá'}</p>
                        ${data.details ? `<p class="error-details">${data.details}</p>` : ''}
                    </div>
                `;
            }

            aiMessages.appendChild(botMsg);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        } catch (error) {
            typingMsg.remove();

            const errorMsg = document.createElement('div');
            errorMsg.className = 'ai-message bot';
            errorMsg.innerHTML = `
                <div class="message-avatar">‚ö†Ô∏è</div>
                <div class="message-bubble error">
                    <p><strong>‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:</strong> ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                </div>
            `;
            aiMessages.appendChild(errorMsg);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }
    }

    aiSendBtn.addEventListener('click', sendAIMessage);
    aiInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendAIMessage();
    });
</script>
{% endblock %}